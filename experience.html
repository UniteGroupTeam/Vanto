<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vanto Experience | Personalización</title>
    <link rel="icon" type="image/png" href="https://imgur.com/kbF7hve.png">

    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-TS3Z2PSR');</script>
    <!-- End Google Tag Manager -->

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CBWCH2BKD1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-CBWCH2BKD1');
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap"
        rel="stylesheet">

    <style>
        /* Global Styles matching Vanto Aesthetics */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #050505;
            color: #E5E5E5;
            font-family: 'Lato', sans-serif;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .serif {
            font-family: 'Playfair Display', serif;
        }

        /* Canvas Container */
        .canvas-container-wrapper {
            position: relative;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TS3Z2PSR" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icons = {
            ArrowLeft: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>,
            Check: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"></polyline></svg>,
            Type: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>,
            Image: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>,
            Download: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
            Trash: ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            Plus: ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Minus: ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
        };

        // Error Boundary to prevent black screen
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            componentDidCatch(error, errorInfo) {
                console.error("React Error:", error, errorInfo);
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-[#050505] flex items-center justify-center text-white p-8">
                            <div className="text-center">
                                <h1 className="text-2xl text-red-500 mb-4">Algo salió mal.</h1>
                                <p className="text-gray-400 text-sm mb-4">{this.state.error && this.state.error.toString()}</p>
                                <button onClick={() => window.location.reload()} className="bg-white text-black px-4 py-2 text-xs uppercase tracking-widest">Recargar</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const CardCustomizer = () => {
            const canvasWrapperRef = useRef(null);
            const [fabricCanvas, setFabricCanvas] = useState(null);
            const [name, setName] = useState("");
            const [selectedColor, setSelectedColor] = useState("black");
            const [productType, setProductType] = useState('standard');
            const [activeObject, setActiveObject] = useState(null);
            const [textCount, setTextCount] = useState(1); // Start with 1 (Name)

            // Card Colors Data (Yellow Removed)
            const colors = [
                { id: 'black', name: 'Negro Mate', hex: '#1a1a1a' },
                { id: 'gold', name: 'Dorado Real', hex: '#D4AF37' },
                { id: 'silver', name: 'Plateado', hex: '#C0C0C0' },
                { id: 'glossy_black', name: 'Negro Brillante', hex: '#000000' },
                { id: 'rose_gold', name: 'Oro Rosa', hex: '#B76E79' },
                { id: 'blue', name: 'Azul', hex: '#0047AB' },
                { id: 'red', name: 'Rojo', hex: '#8B0000' },
                { id: 'purple', name: 'Morado', hex: '#4B0082' },
                { id: 'green', name: 'Verde', hex: '#006400' }
            ];

            const logos = [
                { id: 'original', name: 'Vanto Original', url: 'https://i.imgur.com/9QHzpXh.png' },
                { id: 'icon', name: 'Icono', url: 'https://i.imgur.com/2k2GRCB.png' },
                { id: 'combined', name: 'Logo + Icono', url: 'https://i.imgur.com/RgxKuqr.png' }
            ];

            // Initialize from URL
            useEffect(() => {
                try {
                    const params = new URLSearchParams(window.location.search);
                    const type = params.get('product') || 'standard';
                    setProductType(type);

                    if (type === 'mexico') setSelectedColor('glossy_black');
                    else if (type === 'diamond') setSelectedColor('black'); // Royale
                    else setSelectedColor('blue');
                } catch (e) { console.error("URL Params error:", e); }
            }, []);

            // Mobile Scaling Logic
            useEffect(() => {
                const handleResize = () => {
                    if (canvasWrapperRef.current) {
                        const screenWidth = window.innerWidth;
                        const containerWidth = Math.min(screenWidth - 32, 600); // 32px padding
                        const scale = containerWidth / 600;

                        if (scale < 1) {
                            canvasWrapperRef.current.style.transform = `scale(${scale})`;
                            canvasWrapperRef.current.style.transformOrigin = 'top center';
                            canvasWrapperRef.current.style.marginBottom = `-${(380 * (1 - scale))}px`; // Adjust layout space
                        } else {
                            canvasWrapperRef.current.style.transform = 'none';
                            canvasWrapperRef.current.style.marginBottom = '0';
                        }
                    }
                };

                window.addEventListener('resize', handleResize);
                handleResize(); // Init
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const getMembershipName = () => {
                if (productType === 'mexico') return "VANTO L'HÉRITAGE";
                if (productType === 'diamond') return "VANTO L'ÉLITE";
                return "VANTO L'ESSENTIEL";
            };

            // Initialize Fabric Canvas
            useEffect(() => {
                // Wait for element to be present
                if (!document.getElementById('c')) return;

                // Dispose existing if any (safety check)
                if (fabricCanvas) {
                    try { fabricCanvas.dispose(); } catch (e) { }
                }

                const canvas = new fabric.Canvas('c', {
                    width: 600,
                    height: 380,
                    backgroundColor: '#1a1a1a',
                    selection: true,
                    preserveObjectStacking: true
                });

                // Add card texture/background simulation
                const rect = new fabric.Rect({
                    left: 0,
                    top: 0,
                    fill: '#1a1a1a',
                    width: 600,
                    height: 380,
                    rx: 15,
                    ry: 15,
                    selectable: false,
                    evented: false,
                    name: 'bg_rect'
                });
                canvas.add(rect);
                canvas.sendToBack(rect);

                // Add Membership Level Text (Fixed)
                const membershipText = new fabric.IText(getMembershipName(), {
                    left: 30,
                    top: 320,
                    fontFamily: 'Lato',
                    fill: 'rgba(255, 255, 255, 0.4)', // Laser effect opacity
                    fontSize: 14,
                    charSpacing: 200,
                    selectable: false,
                    evented: false
                });
                canvas.add(membershipText);

                // Add initial text
                const text = new fabric.IText('TU NOMBRE', {
                    left: 50,
                    top: 150,
                    fontFamily: 'Playfair Display',
                    fill: 'rgba(255, 255, 255, 0.6)',
                    fontSize: 40,
                    charSpacing: 100,
                    isUserText: true
                });
                canvas.add(text);

                // Add default logo (Icon)
                fabric.Image.fromURL('https://imgur.com/2k2GRCB.png', function (img) {
                    if (!canvas) return;
                    img.set({
                        left: 480,
                        top: 40,
                        scaleX: 0.1,
                        scaleY: 0.1,
                        opacity: 0.6, // Laser effect
                        isLogo: true, name: 'vanto_logo'
                    });

                    // Apply grayscale filter for opacity effect simulation
                    img.filters.push(new fabric.Image.filters.Grayscale());
                    img.applyFilters();

                    canvas.add(img);
                    canvas.requestRenderAll();
                }, { crossOrigin: 'anonymous' });

                canvas.on('selection:created', (e) => setActiveObject(e.selected ? e.selected[0] : null));
                canvas.on('selection:updated', (e) => setActiveObject(e.selected ? e.selected[0] : null));
                canvas.on('selection:cleared', () => setActiveObject(null));

                // Track text count on modifications
                canvas.on('object:added', updateTextCount);
                canvas.on('object:removed', updateTextCount);

                setFabricCanvas(canvas);

                function updateTextCount() {
                    if (canvas) {
                        try {
                            const count = canvas.getObjects().filter(o => (o.type === 'i-text' || o.type === 'text') && o.isUserText).length;
                            setTextCount(count);
                        } catch (e) { }
                    }
                }

                return () => {
                    canvas.dispose();
                };
            }, [productType]);

            // Update background color when selected color changes
            useEffect(() => {
                if (fabricCanvas) {
                    const colorObj = colors.find(c => c.id === selectedColor);
                    if (colorObj) {
                        try {
                            fabricCanvas.setBackgroundColor(colorObj.hex, fabricCanvas.renderAll.bind(fabricCanvas));
                            // Update background rect too if it exists separately
                            const objects = fabricCanvas.getObjects();
                            const bgRect = objects.find(o => o.name === 'bg_rect');
                            if (bgRect) {
                                bgRect.set('fill', colorObj.hex);
                            }

                            // "Laser Effect" logic: Always keep it colorless/opaque
                            // We use a light grey/white with opacity to simulate the raw metal underneath
                            const laserColor = 'rgba(255, 255, 255, 0.6)';

                            fabricCanvas.getObjects().forEach(obj => {
                                if (obj.type === 'i-text' || obj.type === 'text') {
                                    obj.set('fill', laserColor);
                                }
                                // Maintain filters for images
                            });

                            fabricCanvas.renderAll();
                        } catch (e) { console.error(e); }
                    }
                }
            }, [selectedColor, fabricCanvas]);

            const addText = () => {
                if (!fabricCanvas) return;
                // Limit check (including initial name)
                const currentCount = fabricCanvas.getObjects().filter(o => (o.type === 'i-text' || o.type === 'text') && o.isUserText).length;
                if (currentCount >= 2) {
                    alert("Solo puedes agregar hasta 2 elementos de texto.");
                    return;
                }

                const text = new fabric.IText('TEXTO', {
                    left: 100,
                    top: 100,
                    fontFamily: 'Lato',
                    fill: 'rgba(255, 255, 255, 0.6)',
                    fontSize: 24,
                    isUserText: true
                });
                fabricCanvas.add(text);
                fabricCanvas.setActiveObject(text);
                setTextCount(currentCount + 1);
            };

            const addLogo = (logoUrl) => {
                if (!fabricCanvas) return;

                // Safely remove existing logos using a copy of the array
                const objects = [...fabricCanvas.getObjects()];
                objects.forEach(obj => {
                    if (obj.isLogo || obj.name === 'vanto_logo') {
                        fabricCanvas.remove(obj);
                    }
                });

                fabric.Image.fromURL(logoUrl, function (img) {
                    // Check if canvas is still valid
                    if (!img || !fabricCanvas || fabricCanvas.disposed) return;

                    img.set({
                        left: 200,
                        top: 150,
                        scaleX: 0.15, // Slightly larger base scale
                        scaleY: 0.15,
                        opacity: 0.6,
                        isLogo: true,
                        name: 'vanto_logo'
                    });
                    img.filters.push(new fabric.Image.filters.Grayscale());
                    img.applyFilters();
                    fabricCanvas.add(img);
                    fabricCanvas.setActiveObject(img);
                    fabricCanvas.requestRenderAll(); // FORCE RENDER
                }, { crossOrigin: 'anonymous' });
            };

            const deleteSelected = () => {
                if (fabricCanvas && activeObject) {
                    fabricCanvas.remove(activeObject);
                    fabricCanvas.discardActiveObject();
                    fabricCanvas.renderAll();
                    // Text count updates automatically via event listener
                }
            };

            const downloadCard = () => {
                if (!fabricCanvas) return;
                const dataURL = fabricCanvas.toDataURL({
                    format: 'png',
                    quality: 1
                });
                const link = document.createElement('a');
                link.download = `vanto-card-${name || 'custom'}.png`;
                link.href = dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Categorize colors
            const getHighlightedColors = () => {
                if (productType === 'mexico') return colors.filter(c => ['glossy_black', 'rose_gold'].includes(c.id));
                if (productType === 'diamond') return colors.filter(c => ['black', 'silver', 'gold'].includes(c.id)); // Royale
                return [];
            };

            const getStandardColors = () => {
                const highlighted = getHighlightedColors().map(c => c.id);
                return colors.filter(c => !highlighted.includes(c.id));
            };

            return (
                <div className="min-h-screen bg-[#050505] text-[#E5E5E5] flex flex-col items-center py-10 px-4">
                    <div className="w-full max-w-6xl">
                        <div className="flex justify-between items-center mb-8">
                            <a href="catalogo.html" className="flex items-center gap-2 text-gray-400 hover:text-[#D4AF37] transition-colors text-xs uppercase tracking-widest">
                                <Icons.ArrowLeft size={18} /> Volver
                            </a>
                            <img src="https://imgur.com/O4x44qT.png" alt="Vanto" className="h-8 md:h-12 opacity-80" />
                            <div className="w-20 md:w-32"></div>
                        </div>

                        {/* Flex-col-reverse for Mobile: Controls Below Canvas */}
                        <div className="flex flex-col lg:grid lg:grid-cols-12 gap-8 lg:gap-12">

                            {/* Canvas Section (Top on mobile, Right on Desktop) */}
                            <div className="lg:col-span-8 lg:order-2 flex flex-col items-center">
                                {/* Wrapper for scaling */}
                                <div ref={canvasWrapperRef} className="canvas-container-wrapper mb-6 transition-transform duration-300 ease-out">
                                    <canvas id="c"></canvas>
                                </div>

                                <div className="flex gap-4 flex-wrap justify-center">
                                    <button onClick={addText} disabled={textCount >= 2} className="flex items-center gap-2 bg-[#1a1a1a] hover:bg-[#222] border border-white/10 px-4 py-2 rounded-full text-xs uppercase cursor-pointer tracking-widest transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                        <Icons.Type size={16} /> Texto ({textCount}/2)
                                    </button>

                                    <button onClick={deleteSelected} disabled={!activeObject} className="flex items-center gap-2 bg-red-900/20 hover:bg-red-900/40 border border-red-500/20 px-4 py-2 rounded-full text-xs uppercase tracking-widest transition-all disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer">
                                        <Icons.Trash size={16} /> Eliminar
                                    </button>
                                </div>
                                <p className="text-gray-500 text-[9px] mt-4 max-w-md text-center hidden md:block">
                                    * Usa gestos para mover, escalar y rotar los elementos en tu tarjeta.
                                </p>
                            </div>

                            {/* Controls Section (Bottom on mobile, Left on Desktop) */}
                            <div className="lg:col-span-4 lg:order-1 space-y-6 md:space-y-8">
                                <div>
                                    <h1 className="text-2xl md:text-3xl serif italic text-white mb-2">Vanto Experience</h1>
                                    <p className="text-gray-500 text-xs leading-loose">
                                        Diseña tu tarjeta de membresía de metal.
                                        Nuestras tarjetas representan tu nivel de pertenencia a la comunidad Vanto.
                                    </p>
                                    <p className="text-[#D4AF37] text-[10px] mt-2 italic font-light">
                                        * Nota: Las tarjetas son grabadas con láser de alta precisión, por lo que los logotipos y textos se mostrarán en escala de grises opaca con efecto metálico, no a color.
                                    </p>
                                </div>

                                <div className="p-4 border border-yellow-900/30 bg-yellow-900/10 rounded-sm">
                                    <div className="flex justify-between items-baseline mb-1">
                                        <p className="text-[#D4AF37] text-xs uppercase tracking-widest">Tu Membresía</p>
                                        <a href="membresia.html" target="_blank" className="text-[9px] text-gray-500 hover:text-white underline decoration-1">¿Qué es esto?</a>
                                    </div>
                                    <p className="text-xl serif italic text-white">{getMembershipName()}</p>
                                </div>

                                {/* Colors */}
                                <div>
                                    <h3 className="text-[10px] uppercase tracking-[0.2em] text-[#D4AF37] mb-3 border-b border-white/10 pb-2">Colección Premium</h3>
                                    <div className="flex flex-wrap gap-2 mb-4">
                                        {getHighlightedColors().length > 0 ? getHighlightedColors().map(c => (
                                            <button
                                                key={c.id}
                                                onClick={() => setSelectedColor(c.id)}
                                                className={`w-10 h-10 md:w-12 md:h-12 rounded-full border-2 transition-all duration-300 relative ${selectedColor === c.id ? 'border-[#D4AF37] scale-110 shadow-[0_0_15px_rgba(212,175,55,0.3)]' : 'border-transparent hover:scale-105'}`}
                                                style={{ backgroundColor: c.hex }}
                                                title={c.name}
                                            >
                                                {selectedColor === c.id && <div className="absolute inset-0 flex items-center justify-center"><Icons.Check size={14} className={['black', 'glossy_black', 'purple', 'red'].includes(c.id) ? 'text-white' : 'text-black'} /></div>}
                                            </button>
                                        )) : <p className="text-sm text-gray-600">N/A</p>}
                                    </div>

                                    <h3 className="text-[10px] uppercase tracking-[0.2em] text-gray-500 mb-3 border-b border-white/10 pb-2">Essential Collection</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {getStandardColors().map(c => (
                                            <button
                                                key={c.id}
                                                onClick={() => setSelectedColor(c.id)}
                                                className={`w-8 h-8 md:w-10 md:h-10 rounded-full border transition-all duration-300 relative ${selectedColor === c.id ? 'border-white scale-110' : 'border-white/10 hover:border-white/50'}`}
                                                style={{ backgroundColor: c.hex }}
                                                title={c.name}
                                            >
                                                {selectedColor === c.id && <div className="absolute inset-0 flex items-center justify-center"><Icons.Check size={12} className={['black', 'glossy_black', 'purple', 'green', 'red', 'blue'].includes(c.id) ? 'text-white' : 'text-black'} /></div>}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    <div className="bg-[#111] p-4 rounded-sm border border-white/5">
                                        <label className="text-[10px] uppercase tracking-widest text-gray-500 mb-2 block">Nombre en Tarjeta (Máx 20)</label>
                                        <input
                                            type="text"
                                            value={name}
                                            maxLength={20}
                                            onChange={(e) => {
                                                setName(e.target.value);
                                                if (fabricCanvas) {
                                                    const objs = fabricCanvas.getObjects();
                                                    objs.forEach(o => {
                                                        if (o.type === 'i-text' && o.isUserText && (o.text === 'TU NOMBRE' || o.text === name)) {
                                                            o.set('text', e.target.value.toUpperCase());
                                                        }
                                                    });
                                                    fabricCanvas.renderAll();
                                                }
                                            }}
                                            placeholder="TU NOMBRE"
                                            className="bg-black border border-white/20 text-white px-3 py-2 w-full text-xs outline-none focus:border-[#D4AF37]"
                                        />
                                    </div>

                                    <div className="bg-[#111] p-4 rounded-sm border border-white/5">
                                        <label className="text-[10px] uppercase tracking-widest text-gray-500 mb-2 block">Agregar Logo</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            {logos.map(l => (
                                                <button
                                                    key={l.id}
                                                    onClick={() => addLogo(l.url)}
                                                    className="py-3 px-2 text-[10px] uppercase tracking-widest border border-white/10 text-gray-400 hover:border-[#D4AF37] hover:text-[#D4AF37] hover:bg-[#D4AF37]/10 transition-all flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Plus size={12} /> {l.name}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <button onClick={downloadCard} className="w-full bg-gradient-to-r from-[#D4AF37] to-[#B8860B] text-black px-4 py-4 font-bold tracking-[0.2em] text-xs uppercase rounded-sm hover:shadow-[0_0_20px_rgba(212,175,55,0.4)] transition-all flex items-center justify-center gap-3">
                                        <Icons.Download size={18} /> Confirmar Diseño
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(
            <ErrorBoundary>
                <CardCustomizer />
            </ErrorBoundary>
        );
    </script>
</body>

</html>